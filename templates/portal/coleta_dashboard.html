{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel de Coletas - Portal Reunidas</title>
    <style>
        :root {
            --cor-principal: #012E23; --cor-destaque: #05B540; --cor-alerta: #FFAA00; --cor-info: #007bff; --cor-aviso: #FF6600;
        }
        body { font-family: sans-serif; margin: 0; background-color: #f8f9fa; }
        header { background-color: var(--cor-principal); color: white; padding: 1em 2em; display: flex; justify-content: space-between; align-items: center; }
        .header-logo { height: 40px; }
        .header-user a { color: var(--cor-alerta); text-decoration: none; font-weight: bold; }
        main { padding: 2em; }
        h2 { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5em; margin-bottom: 1.5em; }
        .page-header { display: flex; justify-content: space-between; align-items: center; }
        nav.menu-interno { margin-left: 30px; }
        nav.menu-interno a { color: white; text-decoration: none; margin-left: 20px; font-weight: bold; padding: 5px 0; border-bottom: 2px solid transparent; transition: all 0.2s ease-in-out; }
        nav.menu-interno a:hover { color: var(--cor-alerta); }
        nav.menu-interno a.active { color: var(--cor-alerta); border-bottom-color: var(--cor-alerta); }
        .filtros-container { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); margin-bottom: 2em; display: flex; flex-wrap: wrap; gap: 1.5em; align-items: flex-end; }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-item label { margin-bottom: 0.5em; font-weight: bold; color: #555; }
        .filtro-item input, .filtro-item select { padding: 0.6em; border-radius: 4px; border: 1px solid #ccc; min-width: 200px; }
        .btn { padding: 0.6em 1.2em; border-radius: 4px; border: none; cursor: pointer; font-size: 1em; text-decoration: none; display: inline-block; }
        .btn-filtrar { background-color: #007bff; color: white; }
        .btn-limpar { background-color: #6c757d; color: white; }
        .coleta-card { background-color: #fff; border: 1px solid #dee2e6; border-left: 5px solid var(--cor-info); border-radius: 8px; margin-bottom: 1.5em; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .coleta-header { padding: 1em 1.5em; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .coleta-header h3 { margin: 0; }
        .coleta-body { padding: 1.5em; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2em; }
        .coleta-info p { margin: 0.5em 0; }
        .coleta-actions { display: flex; flex-direction: column; gap: 1.5em; }
        .action-group { background-color: #f8f9fa; padding: 1em; border-radius: 5px; border: 1px solid #e9ecef; }
        .action-group h5 { margin-top: 0; }
        .action-group input, .action-group select, .action-group textarea { width: 95%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
        .action-group button { font-size: 0.9em; padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-agendar { background-color: #007bff; }
        .btn-salvar-planejamento { background-color: var(--cor-destaque); }
        .btn-conferir { background-color: var(--cor-principal); text-align: center; color: white !important; }
        .prioridade-URGENTE { border-left-color: var(--cor-aviso); }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;">
            <img src="{% static 'img/logo_reunidas.png' %}" alt="Logo Reunidas" class="header-logo">
            <nav class="menu-interno">
                <a href="{% url 'portal:comprador_dashboard' %}">Pedidos Pendentes</a>
                <a href="{% url 'portal:comprador_historico' %}">Histórico</a>
                <a href="{% url 'portal:coleta_dashboard' %}" class="active">Painel de Coletas</a>
                <a href="{% url 'portal:relatorios' %}">Relatórios</a>
                <a href="{% url 'portal:gerenciar_locais' %}">Gerenciar Locais</a>
                <a href="{% url 'portal:analise_cotacao' %}">Análise de Cotações</a>
            </nav>
        </div>
        <div class="header-user">
            <span>Olá, {{ request.user.username }}</span> | <a href="{% url 'portal:logout' %}">Sair</a>
        </div>
    </header>

    <main>
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-info">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="page-header">
            <h2>Painel de Planejamento de Coletas</h2>
            <a href="{% url 'portal:adicionar_coleta_avulsa' %}" class="btn btn-filtrar" style="background-color: #17a2b8;">+ Adicionar Coleta Avulsa</a>
        </div>

        <form method="get" class="filtros-container">
            <div class="filtro-item">
                <label for="fornecedor">Fornecedor</label>
                <select name="fornecedor" id="fornecedor" onchange="this.form.submit()">
                    <option value="">-- Todos --</option>
                    {% for f in fornecedores %}
                        <option value="{{ f.id }}" {% if f.id|stringformat:"s" == filtros.fornecedor %}selected{% endif %}>{{ f.nome_fornecedor|truncatechars:40 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filtro-item">
                <label for="municipio">Município</label>
                <select name="municipio" id="municipio" onchange="this.form.submit()">
                    <option value="">-- Todos --</option>
                    {% for m in municipios %}
                        <option value="{{ m }}" {% if m == filtros.municipio %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filtro-item">
                <label for="data_disponibilidade">Data Agendada</label>
                <input type="date" name="data_disponibilidade" id="data_disponibilidade" value="{{ filtros.data_disponibilidade }}" onchange="this.form.submit()">
            </div>
            <div class="filtro-item">
                <label for="status">Status da Coleta</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">-- Todos --</option>
                    {% for status_key, status_value in status_choices %}
                        <option value="{{ status_key }}" {% if status_key == filtros.status %}selected{% endif %}>{{ status_value }}</option>
                    {% endfor %}
                </select>
            </div>
            <a href="{% url 'portal:coleta_dashboard' %}" class="btn btn-limpar">Limpar Filtros</a>
        </form>

        {% for pedido in pedidos_para_coletar %}
            {% for coleta in pedido.coletas.all %}
                <div class="coleta-card prioridade-{{ coleta.prioridade }}">
                    <div class="coleta-header">
                        <h3>{{ pedido.fornecedor_usuario.nome_fornecedor }}</h3>
                        <span>Pedido Nº: <strong><a href="{% url 'portal:comprador_pedido_detalhes' pedido.numero_pedido_display pedido.filial %}" style="color: inherit;">{{ pedido.numero_pedido_display }}</a></strong></span>
                    </div>
                    <div class="coleta-body">
                        <div class="coleta-info">
                            <h4>Detalhes da Coleta</h4>
                            <p><strong>Endereço:</strong> {{ pedido.fornecedor_erp_info.a2_end }}, {{ pedido.fornecedor_erp_info.a2_mun }}</p>
                            <p><strong>Disponível desde:</strong> {{ coleta.data_disponibilidade|date:"d/m/Y" }}</p>
                            <p><strong>Agendado para:</strong> {{ coleta.data_agendada|date:"d/m/Y"|default:"<span style='color:red;'>AGUARDANDO AGENDAMENTO</span>"|safe }}</p>
                            <p><strong>Necessidade:</strong> {{ coleta.data_necessidade|default:"N/A" }}</p>
                            <p><strong>Volumes:</strong> {{ coleta.volumes|default_if_none:"N/A" }} | <strong>Peso:</strong> {{ coleta.peso_kg|localize|default_if_none:"N/A" }} Kg</p>
                            <p><strong>Status:</strong> {{ coleta.get_status_coleta_display }} {% if coleta.conferido_por %}(por {{ coleta.conferido_por.username }}){% endif %}</p>
                            <p><strong>Motorista:</strong> {{ coleta.motorista.nome|default:"<span style='color:red;'>NÃO DEFINIDO</span>"|safe }}</p>


                            {% if coleta.detalhes.all %}
                                <div style="margin-top: 1em;">
                                    <strong>Itens Disponibilizados:</strong>
                                    <ul style="font-size: 0.9em; padding-left: 20px; margin-top: 5px;">
                                        {% for detalhe in coleta.detalhes.all %}
                                            <li>{{ detalhe.quantidade_disponivel|localize }}x {{ detalhe.item_erp.c7_produto }} - {{ detalhe.item_erp.c7_descri }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        <div class="coleta-actions">
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="coleta_id" value="{{ coleta.id }}">
                                <div class="action-group">
                                    <h5>Planejamento da Rota</h5>
                                    <label>Ordem de Visita</label>
                                    <input type="number" name="ordem_visita" value="{{ coleta.ordem_visita|default:0 }}" min="0">
                                    <label>Prioridade</label>
                                    <select name="prioridade">
                                        {% for key, value in prioridade_choices %}
                                            <option value="{{ key }}" {% if key == coleta.prioridade %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                    <label>Motorista</label>
                                    <select name="motorista">
                                        <option value="">-- Nenhum --</option>
                                        {% for motorista in motoristas %}
                                            <option value="{{ motorista.id }}" {% if coleta.motorista.id == motorista.id %}selected{% endif %}>
                                                {{ motorista.nome }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <label>Observação da Coleta</label>
                                    <textarea name="observacao_coleta" rows="2">{{ coleta.observacao_coleta|default_if_none:"" }}</textarea>
                                    <button type="submit" name="salvar_planejamento" class="btn-salvar-planejamento">Salvar Rota</button>
                                </div>
                                <div class="action-group">
                                    <h5>Agendamento</h5>
                                    <input type="date" name="data_agendada" value="{{ coleta.data_agendada|date:'Y-m-d' }}">
                                    <button type="submit" name="agendar_coleta" class="btn-agendar">Salvar Data</button>
                                </div>
                                <a href="{% url 'portal:coleta_conferencia' coleta.id %}" class="btn btn-conferir">Conferir Coleta</a>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}

        <h2 style="margin-top: 2em;">Coletas Avulsas / Extras</h2>
        {% for coleta in coletas_avulsas %}
        <div class="coleta-card prioridade-{{ coleta.prioridade }}" style="border-left-color: var(--cor-alerta);">
            <div class="coleta-header">
                <h3>{{ coleta.fornecedor_avulso }}</h3>
                <span>COLETA AVULSA</span>
            </div>
            <div class="coleta-body">
                 <div class="coleta-info">
                    <h4>Detalhes da Coleta</h4>
                    <p><strong>Motivo/Descrição:</strong> {{ coleta.descricao_avulsa|linebreaksbr|default:"N/A" }}</p>
                    <p><strong>Agendado para:</strong> {{ coleta.data_agendada|date:"d/m/Y" }}</p>
                    <p><strong>Volumes:</strong> {{ coleta.volumes|default_if_none:"N/A" }} | <strong>Peso:</strong> {{ coleta.peso_kg|localize|default_if_none:"N/A" }} Kg</p>
                    <p><strong>Status:</strong> {{ coleta.get_status_coleta_display }} {% if coleta.conferido_por %}(por {{ coleta.conferido_por.username }}){% endif %}</p>
                    <p><strong>Motorista:</strong> {{ coleta.motorista.nome|default:"<span style='color:red;'>NÃO DEFINIDO</span>"|safe }}</p>
                </div>
                <div class="coleta-actions">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="coleta_id" value="{{ coleta.id }}">
                        <div class="action-group">
                            <h5>Planejamento da Rota</h5>
                            <label>Ordem de Visita</label>
                            <input type="number" name="ordem_visita" value="{{ coleta.ordem_visita|default:0 }}" min="0">
                            <label>Prioridade</label>
                            <select name="prioridade">
                                {% for key, value in prioridade_choices %}
                                    <option value="{{ key }}" {% if key == coleta.prioridade %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                            
                            <label>Motorista</label>
                            <select name="motorista">
                                <option value="">-- Nenhum --</option>
                                {% for motorista in motoristas %}
                                    <option value="{{ motorista.id }}" {% if coleta.motorista.id == motorista.id %}selected{% endif %}>
                                        {{ motorista.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label>Observação da Coleta</label>
                            <textarea name="observacao_coleta" rows="2">{{ coleta.observacao_coleta|default_if_none:"" }}</textarea>
                            
                            <button type="submit" name="salvar_planejamento" class="btn-salvar-planejamento">Salvar Rota</button>
                        </div>
                        <a href="{% url 'portal:coleta_avulsa_conferencia' coleta.id %}" class="btn btn-conferir">Conferir Coleta</a>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </main>
</body>
</html>